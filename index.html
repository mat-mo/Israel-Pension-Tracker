<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Pension Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
        .chart-box { height: 500px; width: 100%; } /* Increased height slightly for labels */
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Pension Holdings Tracker</h1>
                <p class="text-gray-500 text-sm">Transparency dashboard for Israeli institutional assets</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-xs text-gray-400 uppercase">Total Assets</p>
                    <p id="totalAssetsDisplay" class="text-xl font-bold text-blue-600">-</p>
                </div>
                <select id="trackSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 shadow-sm w-64">
                    <option disabled selected>Loading tracks...</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="mb-4 border-b border-gray-100 pb-2">
                    <h2 class="font-bold text-lg">1. Asset Allocation</h2>
                    <p class="text-xs text-gray-400">Click a slice to view details</p>
                </div>
                <div id="mainChart" class="chart-box"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <div class="mb-4 border-b border-gray-100 pb-2">
                    <h2 id="subChartTitle" class="font-bold text-lg">2. Category Breakdown</h2>
                    <p class="text-xs text-gray-400">Distribution within selected category</p>
                </div>
                <div id="subChart" class="chart-box"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 id="tableTitle" class="font-bold text-gray-700">Top Holdings</h3>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="tableBadge">Select a Category</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Asset Name</th>
                            <th class="px-6 py-3">Sub-Category</th>
                            <th class="px-6 py-3 text-right">Value (Billions)</th>
                            <th class="px-6 py-3 text-right">% of Category</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody" class="divide-y divide-gray-100">
                        <tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">Click on the Pie Chart to see holdings</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let mainChart = null;
        let subChart = null;
        let currentTrackData = null;

        // Load Data
        fetch('data.json')
            .then(res => res.json())
            .then(data => {
                const tracks = Array.isArray(data) ? data : [data];
                initDashboard(tracks);
            })
            .catch(err => {
                console.error(err);
                alert("Error loading data.json. Check console.");
            });

        function initDashboard(tracks) {
            const selector = document.getElementById('trackSelector');
            selector.innerHTML = '';

            // Handle Institution -> Tracks hierarchy or flat list
            let flatTracks = [];
            if (tracks.length > 0 && tracks[0].institutionName) {
                tracks.forEach(inst => {
                    inst.tracks.forEach(t => {
                        t.fullName = `${inst.institutionName} - ${t.fundName}`;
                        flatTracks.push(t);
                    });
                });
            } else {
                flatTracks = tracks;
            }

            flatTracks.forEach((track, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = track.fullName || track.fundName || track.name;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => loadTrack(flatTracks[e.target.value]));
            
            // Initialize ECharts instances
            mainChart = echarts.init(document.getElementById('mainChart'));
            subChart = echarts.init(document.getElementById('subChart'));

            window.addEventListener('resize', () => {
                mainChart.resize();
                subChart.resize();
            });

            if(flatTracks.length > 0) loadTrack(flatTracks[0]);
        }

        function loadTrack(data) {
            currentTrackData = data;
            const total = data.totalAssetsBN || data.total_value || 0;
            document.getElementById('totalAssetsDisplay').innerText = `₪${total.toLocaleString()}B`;

            // --- MAIN CHART CONFIG ---
            const option = {
                color: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                tooltip: { 
                    trigger: 'item', 
                    formatter: (params) => `<b>${params.name}</b><br/>Value: ${params.value}B<br/>Share: ${params.percent}%` 
                },
                legend: { top: '0%', left: 'center', show: false },
                series: [{
                    name: 'Asset Class',
                    type: 'pie',
                    radius: ['30%', '60%'], // Slightly smaller inner radius to fit labels
                    avoidLabelOverlap: true,
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    
                    // --- LABEL CONFIGURATION (ALWAYS VISIBLE) ---
                    label: { 
                        show: true, 
                        position: 'outside', 
                        formatter: '{b}\n{c}B ({d}%)', // Name \n Value \n Percent
                        color: '#333',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    labelLine: {
                        show: true,
                        length: 15,
                        length2: 10
                    },
                    
                    emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                    data: data.assetClasses.map(item => ({
                        value: item.value,
                        name: item.name
                    }))
                }]
            };
            mainChart.setOption(option, true);

            mainChart.off('click'); 
            mainChart.on('click', function (params) {
                updateSubChart(params.name);
            });

            if(data.assetClasses.length > 0) {
                updateSubChart(data.assetClasses[0].name);
            } else {
                updateSubChart(null);
            }
        }

        function updateSubChart(categoryName) {
            if(!categoryName || !currentTrackData.breakdown || !currentTrackData.breakdown[categoryName]) {
                showNoDataSubChart(categoryName || "Selection");
                return;
            }

            const breakdown = currentTrackData.breakdown[categoryName];
            
            document.getElementById('subChartTitle').innerText = `${categoryName} Breakdown`;
            document.getElementById('tableTitle').innerText = `Top Holdings: ${categoryName}`;
            document.getElementById('tableBadge').innerText = categoryName;

            if (breakdown.length === 0) {
                showNoDataSubChart(categoryName);
                return;
            }

            const pieData = breakdown.map(b => ({
                value: b.value,
                name: b.subclass
            }));

            // --- SUB CHART CONFIG ---
            const option = {
                color: ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa'],
                tooltip: { 
                    trigger: 'item', 
                    formatter: (params) => `<b>${params.name}</b><br/>Value: ${params.value}B<br/>Share: ${params.percent}%` 
                },
                series: [{
                    type: 'pie',
                    radius: ['35%', '65%'],
                    itemStyle: { borderRadius: 4, borderColor: '#fff', borderWidth: 2 },
                    
                    // --- LABEL CONFIGURATION (ALWAYS VISIBLE) ---
                    label: { 
                        show: true, 
                        position: 'outside',
                        formatter: '{b}\n{d}%', // Name \n Percent (Value implied by size)
                        color: '#4b5563'
                    },
                    labelLine: { show: true },
                    
                    data: pieData
                }]
            };
            
            subChart.setOption(option, true);
            updateTable(breakdown);
        }

        function showNoDataSubChart(name) {
            subChart.clear();
            subChart.setOption({
                title: {
                    text: 'No breakdown available',
                    subtext: 'for ' + name,
                    left: 'center',
                    top: 'center',
                    textStyle: { color: '#9ca3af' }
                }
            });
            document.getElementById('holdingsBody').innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No data available</td></tr>';
        }

        function updateTable(breakdown) {
            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = '';
            
            let allHoldings = [];
            breakdown.forEach(sub => {
                if(sub.topHoldings) {
                    sub.topHoldings.forEach(h => {
                        allHoldings.push({ ...h, subclass: sub.subclass });
                    });
                }
            });

            if (allHoldings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No specific holdings data</td></tr>';
                return;
            }

            allHoldings.sort((a, b) => b.value - a.value);

            allHoldings.forEach(h => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <th scope="row" class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${h.name}</th>
                    <td class="px-6 py-3 text-gray-500 text-xs uppercase tracking-wide">${h.subclass}</td>
                    <td class="px-6 py-3 text-right font-mono text-sm">₪${h.value.toFixed(4)}B</td>
                    <td class="px-6 py-3 text-right text-blue-600 font-bold text-sm">${h.percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
