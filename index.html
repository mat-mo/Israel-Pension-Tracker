<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Pension Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
        #chart-container { width: 100%; height: 750px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Pension Holdings Tracker</h1>
                <p class="text-gray-500 mt-1">Transparency dashboard for Israeli institutional assets</p>
            </div>
            <div class="mt-4 md:mt-0">
                <select id="trackSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-64 p-2.5 shadow-sm">
                    <option disabled selected>Loading...</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8 bg-white p-1 rounded-xl shadow-sm border border-gray-100">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-700">Allocation Breakdown</h2>
                    <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-blue-100 text-blue-800">Click to Zoom</span>
                </div>
                <div id="chart-container"></div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-blue-600 p-6 rounded-xl shadow-md text-white">
                    <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Total Fund Assets</p>
                    <h3 id="totalAssetsDisplay" class="text-4xl font-bold mt-2">-</h3>
                    <p class="text-blue-200 text-sm mt-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Updated Q3 2025
                    </p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[500px]">
                    <div class="p-5 border-b border-gray-100 bg-gray-50">
                        <h2 class="font-semibold text-gray-700">Largest Individual Holdings</h2>
                    </div>
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full text-sm text-left">
                            <tbody id="topHoldingsBody" class="divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="mt-12 text-center text-gray-400 text-sm">
            <p>Data source: Capital Market Authority / Institutional Reports</p>
        </footer>
    </div>

    <script>
        let chartInstance = null;
        let allData = [];

        // Fetch Data
        fetch('data.json')
            .then(response => {
                if (!response.ok) throw new Error("HTTP error " + response.status);
                return response.json();
            })
            .then(data => {
                // FIXED: Handle both Single Object and Array formats
                allData = Array.isArray(data) ? data : [data];
                initApp();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('chart-container').innerHTML = 
                    `<div class="flex items-center justify-center h-full text-red-500">Error loading data.json<br>Check console (F12) for details.</div>`;
            });

        function initApp() {
            const selector = document.getElementById('trackSelector');
            selector.innerHTML = ''; 

            allData.forEach((track, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = track.name || `Track ${track.trackId}`;
                selector.appendChild(option);
            });

            selector.addEventListener('change', (e) => renderDashboard(allData[e.target.value]));
            
            // Render first track
            if(allData.length > 0) renderDashboard(allData[0]);
        }

        function renderDashboard(trackData) {
            // Update KPIs
            document.getElementById('totalAssetsDisplay').innerText = `₪${trackData.total_value.toLocaleString()}B`;
            
            // Render Chart
            renderSunburst(trackData);
            
            // Render List
            renderTopList(trackData);
        }

        function renderSunburst(data) {
            const dom = document.getElementById('chart-container');
            if (chartInstance) chartInstance.dispose();
            chartInstance = echarts.init(dom);

            const option = {
                color: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                tooltip: {
                    trigger: 'item',
                    formatter: (params) => {
                        const val = params.value;
                        // Calculate percentage relative to total fund
                        const total = data.total_value;
                        const pct = ((val / total) * 100).toFixed(2);
                        
                        // Path string
                        const path = params.treePathInfo.map(x => x.name).slice(1).join(' > ');
                        
                        return `
                            <div class="font-sans">
                                <div class="text-xs text-gray-400 mb-1">${path}</div>
                                <div class="font-bold text-base mb-1">${params.name}</div>
                                <div class="flex justify-between gap-4 text-sm">
                                    <span>Value:</span> <span class="font-mono">₪${val}B</span>
                                </div>
                                <div class="flex justify-between gap-4 text-sm font-semibold text-blue-500">
                                    <span>Share:</span> <span>${pct}%</span>
                                </div>
                            </div>
                        `;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    textStyle: { color: '#374151' },
                    padding: 12
                },
                series: {
                    type: 'sunburst',
                    data: data.children,
                    radius: ['15%', '90%'],
                    sort: undefined, // Don't auto sort, respect your JSON order
                    emphasis: { focus: 'ancestor' },
                    itemStyle: {
                        borderRadius: 4,
                        borderWidth: 2,
                        borderColor: '#fff'
                    },
                    levels: [
                        {}, // Center (Invisible)
                        {   // Level 1: Asset Class (Stocks, Bonds...)
                            r0: '15%', r: '45%',
                            label: { rotate: 'tangential', align: 'center', fontWeight: 'bold' },
                            itemStyle: { borderWidth: 2 }
                        },
                        {   // Level 2: Sub-class (Direct, ETF, Gov...)
                            r0: '45%', r: '70%',
                            label: { align: 'center', padding: 3, rotate: 'tangential' }
                        },
                        {   // Level 3: Holdings (Leumi, Poalim...)
                            r0: '70%', r: '92%',
                            label: { position: 'outside', padding: 3, silent: false, color: '#6b7280' },
                            itemStyle: { borderWidth: 1, opacity: 0.8 }
                        }
                    ]
                }
            };

            chartInstance.setOption(option);
            window.onresize = () => chartInstance.resize();
        }

        function renderTopList(data) {
            // Flatten the hierarchy to get all holdings
            let flatList = [];
            
            function traverse(node, path) {
                if (!node.children || node.children.length === 0) {
                    if(!node.name.includes("Other")) {
                        flatList.push({ ...node, category: path });
                    }
                } else {
                    node.children.forEach(child => traverse(child, path ? child.name : child.name)); // Simplify path to just immediate parent or keep root
                }
            }
            
            // Start traversal from children of root
            data.children.forEach(c => traverse(c, c.name));
            
            // Sort and Top 20
            flatList.sort((a, b) => b.value - a.value);
            const topList = flatList.slice(0, 20);

            const tbody = document.getElementById('topHoldingsBody');
            tbody.innerHTML = '';

            topList.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-5 py-3">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        <div class="text-xs text-blue-500 font-medium bg-blue-50 inline-block px-1.5 py-0.5 rounded mt-0.5">${item.category}</div>
                    </td>
                    <td class="px-5 py-3 text-right font-mono text-gray-600">
                        ${item.percentage}%
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
