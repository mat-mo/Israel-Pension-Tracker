<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Pension Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
        .chart-box { height: 400px; width: 100%; }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Pension Holdings Tracker</h1>
                <p class="text-gray-500 text-sm">Transparency dashboard for Israeli institutional assets</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-xs text-gray-400 uppercase">Total Assets</p>
                    <p id="totalAssetsDisplay" class="text-xl font-bold text-blue-600">-</p>
                </div>
                <select id="trackSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 shadow-sm w-64">
                    <option disabled selected>Loading tracks...</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="mb-4">
                    <h2 class="font-bold text-lg">1. Asset Allocation</h2>
                    <p class="text-xs text-gray-400">Click a slice to view details</p>
                </div>
                <div id="mainChart" class="chart-box"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <div class="mb-4">
                    <h2 id="subChartTitle" class="font-bold text-lg">2. Category Breakdown</h2>
                    <p class="text-xs text-gray-400">Distribution within selected category</p>
                </div>
                <div id="subChart" class="chart-box"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 id="tableTitle" class="font-bold text-gray-700">Top Holdings</h3>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="tableBadge">Select a Category</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Asset Name</th>
                            <th class="px-6 py-3">Sub-Category</th>
                            <th class="px-6 py-3 text-right">Value (Billions)</th>
                            <th class="px-6 py-3 text-right">% of Category</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody" class="divide-y divide-gray-100">
                        <tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">Click on the Pie Chart to see holdings</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let mainChart = null;
        let subChart = null;
        let currentTrackData = null;

        // Load Data
        fetch('data.json')
            .then(res => res.json())
            .then(data => {
                // Handle if data is array or object
                const tracks = Array.isArray(data) ? data : [data];
                initDashboard(tracks);
            })
            .catch(err => {
                console.error(err);
                alert("Error loading data.json. Check console.");
            });

        function initDashboard(tracks) {
            const selector = document.getElementById('trackSelector');
            selector.innerHTML = '';

            tracks.forEach((track, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = track.fundName || track.name;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => loadTrack(tracks[e.target.value]));
            
            // Initialize ECharts instances
            mainChart = echarts.init(document.getElementById('mainChart'));
            subChart = echarts.init(document.getElementById('subChart'));

            // Handle Resize
            window.addEventListener('resize', () => {
                mainChart.resize();
                subChart.resize();
            });

            // Load first track
            loadTrack(tracks[0]);
        }

        function loadTrack(data) {
            currentTrackData = data;
            
            // 1. Update KPI
            document.getElementById('totalAssetsDisplay').innerText = `₪${data.totalAssetsBN.toLocaleString()}B`;

            // 2. Render Main Donut Chart
            const option = {
                tooltip: { trigger: 'item', formatter: '{b}: {c}B ({d}%)' },
                legend: { top: '5%', left: 'center', show: false },
                series: [{
                    name: 'Asset Class',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    label: { show: true, position: 'outside', formatter: '{b}' },
                    emphasis: { label: { show: true, fontSize: 16, fontWeight: 'bold' } },
                    data: data.assetClasses.map(item => ({
                        value: item.value,
                        name: item.name
                    }))
                }]
            };
            mainChart.setOption(option);

            // 3. Add Click Event
            mainChart.off('click'); // Remove old listeners
            mainChart.on('click', function (params) {
                updateSubChart(params.name);
            });

            // 4. Default: Select biggest category
            if(data.assetClasses.length > 0) {
                updateSubChart(data.assetClasses[0].name);
            }
        }

        function updateSubChart(categoryName) {
            const breakdown = currentTrackData.breakdown[categoryName];
            
            // Update Titles
            document.getElementById('subChartTitle').innerText = `${categoryName} Breakdown`;
            document.getElementById('tableTitle').innerText = `Top Holdings: ${categoryName}`;
            document.getElementById('tableBadge').innerText = categoryName;

            if (!breakdown || breakdown.length === 0) {
                subChart.clear();
                document.getElementById('subChart').innerHTML = "<div class='flex items-center justify-center h-full text-gray-400'>No breakdown available</div>";
                renderTable([]);
                return;
            }

            // Prepare Bar Chart Data
            const categories = breakdown.map(b => b.subclass);
            const values = breakdown.map(b => b.value);

            const option = {
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'Billions' },
                yAxis: { type: 'category', data: categories },
                series: [{
                    name: 'Value',
                    type: 'bar',
                    data: values,
                    itemStyle: { color: '#3b82f6', borderRadius: [0, 4, 4, 0] },
                    label: { show: true, position: 'right', formatter: '{@score}B' }
                }]
            };
            subChart.setOption(option);

            // Update Table
            // Flatten all holdings from all subclasses in this category
            let allHoldings = [];
            breakdown.forEach(sub => {
                sub.topHoldings.forEach(h => {
                    allHoldings.push({
                        ...h,
                        subclass: sub.subclass
                    });
                });
            });
            
            // Sort by value
            allHoldings.sort((a, b) => b.value - a.value);
            renderTable(allHoldings);
        }

        function renderTable(holdings) {
            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = '';

            if (holdings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No specific holdings data</td></tr>';
                return;
            }

            holdings.forEach(h => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${h.name}</th>
                    <td class="px-6 py-4 text-gray-500">${h.subclass}</td>
                    <td class="px-6 py-4 text-right font-mono">₪${h.value.toFixed(4)}B</td>
                    <td class="px-6 py-4 text-right text-blue-600 font-semibold">${h.percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
