<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Pension Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
        .chart-box { height: 400px; width: 100%; }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Pension Holdings Tracker</h1>
                <p class="text-gray-500 text-sm">Transparency dashboard for Israeli institutional assets</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Institution</label>
                    <select id="institutionSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 shadow-sm w-48">
                        <option disabled selected>Loading...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Fund Track</label>
                    <select id="trackSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 shadow-sm w-64" disabled>
                        <option disabled selected>Select Institution First</option>
                    </select>
                </div>

                <div class="text-right hidden md:block pl-4 border-l border-gray-200">
                    <p class="text-xs text-gray-400 uppercase">Total Assets</p>
                    <p id="totalAssetsDisplay" class="text-xl font-bold text-blue-600">-</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="mb-4">
                    <h2 class="font-bold text-lg">1. Asset Allocation</h2>
                    <p class="text-xs text-gray-400">Click a slice to view category details</p>
                </div>
                <div id="mainChart" class="chart-box"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <div class="mb-4">
                    <h2 id="subChartTitle" class="font-bold text-lg">2. Category Breakdown</h2>
                    <p class="text-xs text-gray-400">Distribution within selected category</p>
                </div>
                <div id="subChart" class="chart-box"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 id="tableTitle" class="font-bold text-gray-700">Top Holdings</h3>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="tableBadge">Select a Category</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Asset Name</th>
                            <th class="px-6 py-3">Sub-Category</th>
                            <th class="px-6 py-3 text-right">Value (Billions)</th>
                            <th class="px-6 py-3 text-right">% of Category</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody" class="divide-y divide-gray-100">
                        <tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">Click on the Pie Chart to see holdings</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let allData = [];
        let currentInstitution = null;
        let currentTrackData = null;
        let mainChart = null;
        let subChart = null;

        // Fetch Data
        fetch('data.json')
            .then(res => res.json())
            .then(data => {
                allData = data;
                initApp();
            })
            .catch(err => console.error("Error loading data:", err));

        function initApp() {
            const instSelector = document.getElementById('institutionSelector');
            instSelector.innerHTML = '<option disabled selected>Select Institution</option>';

            allData.forEach((inst, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = inst.institutionName;
                instSelector.appendChild(opt);
            });

            instSelector.addEventListener('change', (e) => {
                const selectedInst = allData[e.target.value];
                populateTracks(selectedInst);
            });

            // Init Charts
            mainChart = echarts.init(document.getElementById('mainChart'));
            subChart = echarts.init(document.getElementById('subChart'));
            
            // Handle Resize
            window.addEventListener('resize', () => {
                mainChart.resize();
                subChart.resize();
            });
            
            // Auto-select first institution if available
            if(allData.length > 0) {
                instSelector.value = 0;
                populateTracks(allData[0]);
            }
        }

        function populateTracks(institution) {
            currentInstitution = institution;
            const trackSelector = document.getElementById('trackSelector');
            trackSelector.innerHTML = '';
            trackSelector.disabled = false;

            institution.tracks.forEach((track, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = track.fundName;
                trackSelector.appendChild(opt);
            });

            trackSelector.removeEventListener('change', handleTrackChange);
            trackSelector.addEventListener('change', handleTrackChange);

            // Load first track
            if (institution.tracks.length > 0) {
                loadTrack(institution.tracks[0]);
            }
        }

        function handleTrackChange(e) {
            loadTrack(currentInstitution.tracks[e.target.value]);
        }

        function loadTrack(data) {
            currentTrackData = data;
            
            // Update KPI
            document.getElementById('totalAssetsDisplay').innerText = `₪${data.totalAssetsBN.toLocaleString()}B`;

            // Render Main Donut
            const option = {
                tooltip: { trigger: 'item', formatter: '{b}: {c}B ({d}%)' },
                series: [{
                    name: 'Asset Class',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    label: { show: true, position: 'outside', formatter: '{b}\n{d}%' },
                    data: data.assetClasses.map(item => ({
                        value: item.value,
                        name: item.name
                    }))
                }]
            };
            mainChart.setOption(option);

            // Click Event
            mainChart.off('click');
            mainChart.on('click', function (params) {
                updateSubChart(params.name);
            });

            // Default selection: Largest asset class
            if (data.assetClasses.length > 0) {
                updateSubChart(data.assetClasses[0].name);
            }
        }

        function updateSubChart(categoryName) {
            const breakdown = currentTrackData.breakdown[categoryName];
            
            // Update UI Titles
            document.getElementById('subChartTitle').innerText = `${categoryName} Breakdown`;
            document.getElementById('tableTitle').innerText = `Top Holdings: ${categoryName}`;
            document.getElementById('tableBadge').innerText = categoryName;

            if (!breakdown || breakdown.length === 0) {
                subChart.clear();
                document.getElementById('subChart').innerHTML = "<div class='flex items-center justify-center h-full text-gray-400'>No breakdown available</div>";
                renderTable([]);
                return;
            }

            // Render Bar Chart
            const categories = breakdown.map(b => b.subclass);
            const values = breakdown.map(b => b.value);

            const option = {
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'Billions' },
                yAxis: { type: 'category', data: categories },
                series: [{
                    name: 'Value',
                    type: 'bar',
                    data: values,
                    itemStyle: { color: '#3b82f6', borderRadius: [0, 4, 4, 0] },
                    label: { show: true, position: 'right', formatter: '{@score}B' }
                }]
            };
            subChart.setOption(option);

            // Render Table
            let allHoldings = [];
            breakdown.forEach(sub => {
                sub.topHoldings.forEach(h => {
                    allHoldings.push({ ...h, subclass: sub.subclass });
                });
            });
            allHoldings.sort((a, b) => b.value - a.value);
            renderTable(allHoldings);
        }

        function renderTable(holdings) {
            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = '';

            if (holdings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No specific holdings data</td></tr>';
                return;
            }

            holdings.forEach(h => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${h.name}</th>
                    <td class="px-6 py-4 text-gray-500">${h.subclass}</td>
                    <td class="px-6 py-4 text-right font-mono">₪${h.value.toFixed(4)}B</td>
                    <td class="px-6 py-4 text-right text-blue-600 font-semibold">${h.percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
